<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>LIFF EAN-13 Scanner – Focus Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

  <style>
    body {
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 6px;
    }

    #camera {
      position: relative;
      width: 100%;
      max-width: 360px;
      aspect-ratio: 4 / 3;
      margin: 0 auto;
      background: #000;
      display: none;
      overflow: hidden;
      border-radius: 12px;
    }

    #camera video,
    #camera canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* === UX Focus Guide === */

    #focus-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 180px;
      height: 180px;
      transform: translate(-50%, -50%);
      border: 2px dashed rgba(255,255,255,0.8);
      border-radius: 50%;
      pointer-events: none;
    }

    #focus-text {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 13px;
      pointer-events: none;
    }

    #frame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 220px;
      height: 140px;
      transform: translate(-50%, -50%);
      border: 2px solid #00c300;
      border-radius: 8px;
      pointer-events: none;
    }

    button {
      margin-top: 12px;
      padding: 12px;
      width: 100%;
      max-width: 360px;
      font-size: 16px;
      background: #00c300;
      color: #fff;
      border: none;
      border-radius: 8px;
    }

    button:disabled {
      background: #ccc;
    }

    #result {
      margin-top: 16px;
      font-size: 18px;
      font-weight: bold;
    }

    #status {
      margin-top: 6px;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>

<h1>EAN-13 Scanner</h1>

<div id="camera">
  <div id="frame"></div>
  <div id="focus-ring"></div>
  <div id="focus-text">ถือมือถือห่างจากบาร์โค้ด ~1 ฝ่ามือ</div>
</div>

<button id="startBtn">เปิดกล้องสแกนบาร์โค้ด</button>

<div id="result"></div>
<div id="status">สถานะ: รอเริ่มต้น</div>
<div id="device">กล้อง: รอเริ่มต้น</div>

<script>
  const LIFF_ID = "2008742009-qDKcYJFh";

  const startBtn = document.getElementById("startBtn");
  const cameraEl = document.getElementById("camera");
  const resultEl = document.getElementById("result");
  const statusEl = document.getElementById("status");
  const focusTextEl = document.getElementById("focus-text");

  const deviceEl = document.getElementById("device");

  let scanning = false;
  let detectedCount = {};
  let devices = '';

  async function initLIFF() {
    await liff.init({ liffId: LIFF_ID });
  }

  function startScanner() {
    if (scanning) return;

    scanning = true;
    detectedCount = {};
    cameraEl.style.display = "block";
    startBtn.disabled = true;
    statusEl.textContent = "สถานะ: กำลังสแกน…";
    focusTextEl.textContent = "ถือมือถือห่างจากบาร์โค้ด ~1 ฝ่ามือ";
    
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: cameraEl,
        constraints: {
          facingMode: "environment",
          width: { min: 1600 },
          height: { min: 960 },
          deviceId: devices
        },
        area: {
          top: "30%",
          right: "10%",
          left: "10%",
          bottom: "30%"
        }
      },
      frequency: 10,
      decoder: {
        readers: ["ean_reader"]
      },
      locate: true,
      locator: {
        patchSize: "medium",
        halfSample: true
      },
      numOfWorkers: 1
      }, err => {
      if (err) {
        statusEl.textContent = "เปิดกล้องไม่สำเร็จ";
        startBtn.disabled = false;
        scanning = false;
        return;
      }
      Quagga.start();
      });
      
      Quagga.onProcessed(onProcessed);
      Quagga.onDetected(onDetected);
  }

  function onDetected(data) {
    const code = data.codeResult.code;
    if (!code || code.length !== 13) return;

    detectedCount[code] = (detectedCount[code] || 0) + 1;

    if (detectedCount[code] === 1) {
      focusTextEl.textContent = "นิ่งไว้นิดหนึ่ง กำลังอ่านบาร์โค้ด…";
    }

    if (detectedCount[code] >= 3) {
      finalize(code);
    }
  }

  function finalize(code) {
    Quagga.stop();
    Quagga.offDetected(onDetected);
    Quagga.offProcessed(onProcessed);

    scanning = false;
    startBtn.disabled = false;
    cameraEl.style.display = "none";

    resultEl.textContent = "EAN-13: " + code;
    statusEl.textContent = "สแกนสำเร็จ";

    if (navigator.vibrate) navigator.vibrate(200);
  }

  function onProcessed(result) {
    // UX-driven focus hint
    if (!result || !result.box) {
      focusTextEl.textContent = "ลองขยับมือถือเข้า–ออกเล็กน้อย";
    }
    
    var drawingCtx = Quagga.canvas.ctx.overlay, drawingCanvas = Quagga.canvas.dom.overlay;   
    
    if (result) {
        if (result.boxes) {
            drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
            result.boxes.filter(function (box) {
                return box !== result.box;
            }).forEach(function (box) {
                Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "orange", lineWidth: 2});
            });
        }

        if (result.box) {
            Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
        }

        if (result.codeResult && result.codeResult.code) {
            Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
        }
    }    
  }

  startBtn.addEventListener("click", startScanner);
  initLIFF();

  Quagga.CameraAccess.enumerateVideoDevices({
      facingMode: 'environment'
  }).then(function(d) {
    devices = d[d.length - 1].deviceId;
    deviceEl.textContent += devices.label + ' ' +devices.deviceId
  }) 
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>EAN-13 Scanner Fixed</title>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

<style>
  body { margin:0; background:#000; color:#fff; font-family:Arial }
  #controls { padding:10px; background:#111 }
  select, button { font-size:14px; margin-right:6px }

  #scanner-wrapper {
    position:relative;
    height:calc(100vh - 140px);
  }

  #scanner-container { position:absolute; inset:0; z-index:1 }

  #ux-overlay {
    position:absolute; inset:0;
    z-index:20; pointer-events:none;
  }

  #focus-frame {
    position:absolute;
    top:50%; left:50%;
    width:80%; max-width:420px;
    aspect-ratio:3.5/1;
    transform:translate(-50%,-50%);
    border:3px solid #00ffcc;
    box-shadow:0 0 0 9999px rgba(0,0,0,.35);
    border-radius:8px;
  }

  #hint {
    position:absolute;
    top:calc(50% + 100px);
    width:100%;
    text-align:center;
  }

  #result { padding:10px; background:#111 }
</style>
</head>

<body>

<div id="controls">
  <select id="cameraSelect"></select>
  <button onclick="startScanner()">Start</button>
  <label>
    <input type="checkbox" id="debugToggle" checked> Debug
  </label>
</div>

<div id="scanner-wrapper">
  <div id="scanner-container"></div>
  <div id="ux-overlay">
    <div id="focus-frame"></div>
    <div id="hint">จัดบาร์โค้ดให้อยู่ในกรอบ</div>
  </div>
</div>

<div id="result">Result: <span id="code">-</span></div>

<script>
let lastResult = null;
let detected = false;

async function listCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  cameraSelect.innerHTML = "";
  devices.filter(d=>d.kind==="videoinput").forEach((d,i)=>{
    const o=document.createElement("option");
    o.value=d.deviceId;
    o.text=d.label||`Camera ${i}`;
    cameraSelect.appendChild(o);
  });
}

function startScanner() {
  detected = false;
  lastResult = null;

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:"#scanner-container",
      constraints:{
        deviceId:cameraSelect.value,
        facingMode:"environment",
        width:{ideal:1600},
        height:{ideal:900}
      }
    },
    locate:true,
    decoder:{ readers:["ean_reader"] },
    debug:{
      drawBoundingBox:true,
      drawScanline:true,
      showPattern:true
    }
  }, err=>{
    if(err){ alert(err); return }
    Quagga.start();
  });

  Quagga.onProcessed(onProcessed);
  Quagga.onDetected(onDetected);
}

function onProcessed(result){
  const ctx = Quagga.canvas.ctx.overlay;
  const canvas = Quagga.canvas.dom.overlay;
  if(!ctx) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!debugToggle.checked) return;

  if(result) lastResult = result;
  if(!lastResult) return;

  if(lastResult.box)
    Quagga.ImageDebug.drawPath(
      lastResult.box,{x:0,y:1},ctx,
      {color:"red",lineWidth:3}
    );

  if(lastResult.line)
    Quagga.ImageDebug.drawPath(
      lastResult.line,{x:"x",y:"y"},ctx,
      {color:"red",lineWidth:3}
    );
}

function onDetected(res){
  document.getElementById("code").textContent = res.codeResult.code;
  document.getElementById("hint").textContent = "สแกนสำเร็จ";
  Quagga.stop();
}

navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
  s.getTracks().forEach(t=>t.stop());
  listCameras();
});
</script>

</body>
</html>
